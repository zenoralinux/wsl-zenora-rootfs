name: Build rootfs

on:
  workflow_dispatch:
  schedule:
    - cron: '24 7 1 * *'

jobs:
  build-rootfs:
    runs-on: ubuntu-latest
    name: "Build rootfs"
    container: 
      image: archlinux/archlinux
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare container environment
        run: | 
          pacman-key --init
          pacman-key --populate
          pacman -Sy --noconfirm archlinux-keyring
          pacman -Syu --noconfirm
          pacman -S --noconfirm arch-install-scripts wget curl base-devel zip unzip

      - name: Set image version and prepare rootfs
        run: |
          echo "IMAGE_VERSION=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir /mnt/sys-root-skeleton /mnt/sys-root
          mount --bind /mnt/sys-root-skeleton /mnt/sys-root
          wget -O target-pacman.conf https://raw.githubusercontent.com/zenoralinux/wsl-zenora-rootfs/refs/heads/main/pacman.conf

      - name: Modify pacman.conf to reorder repos and add new repos
        run: |
          # Move zrepo to top (inserted first)
          sed -i '/\[zrepo\]/d' target-pacman.conf
          sed -i '1i[zrepo]\nSigLevel = Never\nServer = https://codeberg.org/zenoralinux/zenora-repo/media/branch/main/$arch\n' target-pacman.conf

          # Add archlinuxcn and blackarch at the end if not present
          grep -q '\[archlinuxcn\]' target-pacman.conf || \
            echo -e "\n[archlinuxcn]\nSigLevel = Never\nServer = https://repo.archlinuxcn.org/\$arch" >> target-pacman.conf
          grep -q '\[blackarch\]' target-pacman.conf || \
            echo -e "\n[blackarch]\nSigLevel = Never\nServer = https://blackarch.org/blackarch/\$repo/os/\$arch" >> target-pacman.conf

      - name: Initialize rootfs base system
        run: |
          pacstrap -G -M -C target-pacman.conf -K /mnt/sys-root base curl wget vim nano sudo texinfo man-db man-pages zsh

      - name: Configure rootfs (mirror, locale, sudo, services)
        run: |
          sed -i -e 's/^#Server/Server/g' /mnt/sys-root/etc/pacman.d/mirrorlist
          sed -i -e 's/^#Color/Color/g' -e 's/^#ParallelDownloads/ParallelDownloads/g' /mnt/sys-root/etc/pacman.conf
          sed -i -e 's/^#en_US.UTF-8/en_US.UTF-8/g' /mnt/sys-root/etc/locale.gen
          echo "%wheel ALL=(ALL:ALL) ALL" > /mnt/sys-root/etc/sudoers.d/wheel
          echo "tmpfs /tmp tmpfs mode=1777,strictatime,nosuid,nodev,size=50%,nr_inodes=1m 0 0" >> /mnt/sys-root/etc/fstab
          arch-chroot /mnt/sys-root locale-gen
          arch-chroot /mnt/sys-root systemctl mask systemd-binfmt.service systemd-resolved.service systemd-networkd.service tmp.mount
          rm -rf /mnt/sys-root/etc/pacman.d/gnupg
          rm -rf /mnt/sys-root/var/lib/pacman/sync/
          rm -f /mnt/sys-root/etc/machine-id
          touch /mnt/sys-root/etc/machine-id
          rm -rf /mnt/sys-root/var/cache/pacman/pkg/*

          # ایجاد یوزر zenora با پسورد zenora و شل zsh و اضافه کردن به گروه wheel برای sudo
          arch-chroot /mnt/sys-root useradd -m -G wheel -s /bin/zsh zenora
          echo "zenora:zenora" | arch-chroot /mnt/sys-root chpasswd

      - name: Copy pacman.conf & install Zenora packages inside chroot
        run: |
          cp target-pacman.conf /mnt/sys-root/etc/pacman.conf
          cp -r /etc/pacman.d /mnt/sys-root/etc/
          arch-chroot /mnt/sys-root pacman -Sy --noconfirm
          arch-chroot /mnt/sys-root pacman -S --noconfirm \
            zenora-release \
            zenora-fake-apt \
            zenora-back \
            zenora-zsh-config \
            zenora-conf-update \
            neofetch \
            zsh

      - name: Configure WSL integration
        run: |
          mkdir -p /mnt/sys-root/usr/lib/wsl
          cp zenora.ico /mnt/sys-root/usr/lib/wsl/zenora.ico
          cp wsl-oobe.sh /mnt/sys-root/usr/lib/wsl/oobe.sh
          chmod +x /mnt/sys-root/usr/lib/wsl/oobe.sh
          cp wsl.conf /mnt/sys-root/etc/wsl.conf
          cp wsl-distribution.conf /mnt/sys-root/etc/wsl-distribution.conf

      - name: Package final rootfs
        run: |
          tar -czf zenora.wsl -C /mnt/sys-root ./

      - name: Generate sha256sums
        run: |
          sha256sum zenora.wsl > sha256sums

      - name: Upload the final artifact
        uses: softprops/action-gh-release@v0.1.15
        with:
          tag_name: "${{ env.IMAGE_VERSION }}"
          files: |
            zenora.wsl
            sha256sums
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
